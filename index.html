<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>מעקב משימות</title>
  
  <!-- PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="מעקב משימות">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#6366f1">
  
  <!-- Icons -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%236366f1'/><rect x='25' y='25' width='50' height='50' fill='none' stroke='%23fff' stroke-width='2'/><polyline points='35,50 45,60 65,40' fill='none' stroke='%23fff' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/></svg>">
  
  <!-- Web App Manifest -->
  <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;מעקב משימות&quot;,&quot;short_name&quot;:&quot;משימות&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%23ffffff&quot;,&quot;theme_color&quot;:&quot;%236366f1&quot;,&quot;orientation&quot;:&quot;portrait&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%236366f1'/><rect x='48' y='48' width='96' height='96' fill='none' stroke='%23fff' stroke-width='4'/><polyline points='67,96 86,115 125,76' fill='none' stroke='%23fff' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'/></svg>&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">

  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
  /* שינוי קל בצבעים כדי ליצור מראה יוקרתי יותר */
  --bg-primary: #ffffff; /* נשאר לבן נקי */
  --bg-secondary: #f0f4f8; /* אפור בהיר מאוד, יותר נעים */
  --bg-tertiary: #e2e8f0; /* אפור בינוני בהיר */
  
  --text-primary: #1a202c; /* כהה יותר, רציני יותר */
  --text-secondary: #4a5568; /* אפור כהה יותר */
  --text-tertiary: #a0aec0; /* אפור עדין */
  
  --border-light: #edf2f7; /* גבולות בהירים ועדינים */
  --border-medium: #cbd5e0; /* גבולות מודגשים יותר */
  
  --accent: #4c51bf; /* סגול-כחול עמוק יותר */
  --accent-light: #7f84e8;
  --accent-dark: #373b8a;
  
  --success: #0d9488; /* ירוק-טורקיז עמוק יותר */
  --success-light: #2dd4bf;
  --warning: #d97706; /* כתום חזק יותר */
  --warning-light: #fbbf24;
  --danger: #dc2626; /* אדום חזק יותר */
  --danger-light: #f87171;
  
  --purple: #6b46c1; /* סגול עמוק יותר */
  --blue: #3b82f6;
  --emerald: #059669;
  --orange: #ea580c;
  
  /* שינוי צלליות למראה רך ועמוק יותר */
  --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.08), 0 1px 2px 0 rgba(0, 0, 0, 0.04);
  --shadow-md: 0 4px 10px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 12px 25px rgba(0, 0, 0, 0.15), 0 6px 10px rgba(0, 0, 0, 0.08);
  --shadow-colored: 0 6px 15px rgba(76, 81, 191, 0.2), 0 2px 5px rgba(76, 81, 191, 0.1);
  
  --radius: 10px; /* פינות מעוגלות יותר, תחושה מודרנית */
  --radius-lg: 16px; /* פינות מעוגלות יותר בכרטיסים גדולים */
}

* {
  box-sizing: border-box;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  margin: 0;
  padding: 0;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  /* רקע: נשנה לגרדיאנט עדין יותר של אפור-כחול, או נשתמש בצבע אחיד אם רוצים סולידיות מירבית */
  background: linear-gradient(135deg, #e0e7ff 0%, #c3dafe 100%); /* גרדיאנט בהיר ורך */
  /* אפשרות נוספת לרקע סולידי ורציני: background-color: var(--bg-secondary); */
  background-attachment: fixed;
  color: var(--text-primary);
  line-height: 1.6; /* הגדלה קלה לשיפור קריאות */
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  min-height: 100vh;
}

.container {
  max-width: 1000px; /* צמצום קל לריכוז התוכן */
  margin: 0 auto;
  padding: 0 24px;
}

.header {
  background: rgba(255, 255, 255, 0.98); /* כמעט אטום למראה יוקרתי יותר */
  backdrop-filter: blur(30px); /* הגדלת טשטוש */
  border-bottom: 1px solid var(--border-light);
  padding: 28px 0; /* הקטנה קלה למראה הדוק יותר */
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.header h1 {
  font-size: 30px; /* גודל אופטימלי */
  font-weight: 800; /* הדגשה חזקה */
  margin: 0 0 4px 0; /* צמצום מרווח תחתון */
  background: linear-gradient(135deg, var(--accent), var(--purple));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.header p {
  font-size: 14px; /* הקטנה קלה, אבל ברורה */
  color: var(--text-secondary);
  margin: 0;
  font-weight: 500;
}

.section {
  margin-bottom: 32px; /* שמירה על מרווחים נקיים */
}

.card {
  background: var(--bg-primary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md); /* צללית מודגשת אך רכה */
  transition: all 0.3s ease;
  overflow: hidden;
}

.card:hover {
  transform: translateY(-3px); /* אפקט הובר בולט יותר */
  box-shadow: var(--shadow-lg); /* צללית גדולה יותר בהובר */
}

.card-header {
  padding: 24px 24px 0; /* שמירה על מרווחים */
  border-bottom: none;
}

.card-body {
  padding: 24px;
}

.card-title {
  font-size: 20px; /* הגדלה קלה לכותרות המשנה */
  font-weight: 700; /* הדגשה */
  margin: 0;
  color: var(--text-primary);
}

.grid {
  display: grid;
  gap: 20px;
}

.grid-2 { grid-template-columns: 1fr 1fr; }
.grid-4 { grid-template-columns: repeat(4, 1fr); }

@media (max-width: 768px) {
  .grid-2 { grid-template-columns: 1fr; }
  .grid-4 { grid-template-columns: repeat(2, 1fr); } /* 2 עמודות במובייל עבור סטטיסטיקות */
  .container { padding: 0 16px; }
  .section { margin-bottom: 24px; }
  
  .header h1 {
    font-size: 26px; /* גודל מותאם למובייל */
  }
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 14px 28px; /* הגדלת פאדינג לכפתורים נוחים יותר למגע */
  border: 1px solid transparent;
  border-radius: var(--radius);
  font-size: 15px; /* הגדלת פונט */
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  white-space: nowrap;
}

.btn:focus {
  outline: 3px solid var(--accent-light); /* הדגשת פוקוס ברורה יותר */
  outline-offset: 2px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent), var(--accent-dark));
  color: white;
  border-color: var(--accent);
  box-shadow: var(--shadow-colored);
}

.btn-primary:hover {
  transform: translateY(-2px); /* אפקט הובר בולט יותר */
  box-shadow: 0 10px 30px rgba(76, 81, 191, 0.3); /* צללית מוגברת בהובר */
}

.btn-secondary {
  background: var(--bg-primary);
  color: var(--text-primary);
  border-color: var(--border-medium);
}

.btn-secondary:hover {
  background: var(--bg-secondary);
  transform: translateY(-1px);
}

.btn-danger {
  background: linear-gradient(135deg, var(--danger), #b91c1c); /* אדום עמוק יותר */
  color: white;
  border-color: var(--danger);
}

.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(220, 38, 38, 0.3);
}

.btn-icon {
  padding: 12px;
  min-width: 48px; /* גודל אחיד לאייקונים */
  height: 48px;
}

.input {
  width: 100%;
  padding: 16px 20px; /* הגדלת פאדינג לשדות קלט נוחים יותר */
  border: 2px solid var(--border-medium);
  border-radius: var(--radius);
  font-size: 16px;
  background: var(--bg-primary);
  color: var(--text-primary);
  transition: all 0.2s ease;
}

.input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 4px rgba(76, 81, 191, 0.15); /* צללית פוקוס בולטת יותר */
}

.input::placeholder {
  color: var(--text-tertiary);
}

.task-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 24px; /* הגדלת פאדינג ושינוי צדדים */
  border: 1px solid var(--border-light);
  border-radius: var(--radius); /* פחות מעוגל מהכרטיס הראשי */
  background: var(--bg-primary);
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-sm); /* צללית קלה לכל משימה */
}

.task-item::before {
  content: '';
  position: absolute;
  right: 0; /* שינוי כיוון הקו הצדדי לימין עבור RTL */
  top: 0;
  bottom: 0;
  width: 5px; /* הגדלת עובי הקו */
  background: linear-gradient(135deg, var(--accent), var(--purple));
  opacity: 0;
  transition: opacity 0.2s ease, width 0.2s ease; /* אנימציה גם לרוחב */
}

.task-item:hover {
  border-color: var(--accent-light);
  box-shadow: var(--shadow-md);
  transform: translateY(-2px); /* אפקט הובר בולט יותר */
}

.task-item:hover::before {
  opacity: 1;
  width: 8px; /* הגדלת עובי הקו בהובר */
}

.task-name {
  font-weight: 500;
  color: var(--text-primary);
  flex: 1;
  margin-right: 16px; /* מרווח ימינה עבור RTL */
  font-size: 16px; /* גודל פונט קצת יותר גדול */
}

.task-actions {
  display: flex;
  gap: 10px; /* הגדלת רווח בין כפתורים */
}

.status-btn {
  width: 48px; /* הגדלת כפתורים למגע קל */
  height: 48px;
  border-radius: 50%; /* עיגול מושלם */
  border: 2px solid var(--border-medium);
  background: var(--bg-primary);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px; /* הגדלת אייקונים */
  position: relative;
  box-shadow: var(--shadow-sm); /* צללית קלה לכפתורים */
}

.status-btn:hover {
  border-color: var(--accent);
  background: var(--bg-secondary);
  transform: scale(1.08); /* אפקט הובר בולט */
}

.status-btn.success {
  background: linear-gradient(135deg, var(--success), var(--emerald)); /* גרדיאנט חזק יותר */
  color: white;
  border-color: var(--success);
  box-shadow: 0 4px 15px rgba(13, 148, 136, 0.3);
}

.status-btn.warning {
  background: linear-gradient(135deg, var(--warning), var(--orange)); /* גרדיאנט חזק יותר */
  color: white;
  border-color: var(--warning);
  box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3);
}

.status-btn.danger {
  background: linear-gradient(135deg, var(--danger), #b91c1c); /* גרדיאנט חזק יותר */
  color: white;
  border-color: var(--danger);
  box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
}

.stat-card {
  text-align: center;
  padding: 30px 20px; /* הגדלת פאדינג */
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px; /* עובי פס הדגשה */
  background: linear-gradient(90deg, var(--accent), var(--purple));
}

.stat-card:nth-child(1)::before { background: linear-gradient(90deg, var(--success), var(--emerald)); }
.stat-card:nth-child(2)::before { background: linear-gradient(90deg, var(--blue), var(--accent)); }
.stat-card:nth-child(3)::before { background: linear-gradient(90deg, var(--purple), var(--accent)); }
.stat-card:nth-child(4)::before { background: linear-gradient(90deg, var(--orange), var(--warning)); }

.stat-value {
  font-size: 42px; /* גודל גדול ומרשים */
  font-weight: 800;
  margin: 12px 0 8px;
  color: var(--text-primary);
}

.stat-label {
  font-size: 14px; /* קריא וברור */
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.08em; /* רווח אותיות קל */
}

.chart-container {
  position: relative;
  height: 280px;
  padding: 0;
}

.message {
  padding: 24px;
  border-radius: var(--radius-lg);
  font-weight: 500;
  border-right: 6px solid; /* קו צד ימין עבור RTL */
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-sm); /* צללית קלה להודעות */
}

.message::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
  pointer-events: none;
}

/* התאמת צבעים להודעות */
.message-success {
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
  border-color: var(--success);
  color: #065f46;
}

.message-warning {
  background: linear-gradient(135deg, #fffbeb, #fef3c7);
  border-color: var(--warning);
  color: #9a3412;
}

.message-danger {
  background: linear-gradient(135deg, #fef2f2, #fecaca);
  border-color: var(--danger);
  color: #991b1b;
}

.empty-state {
  text-align: center;
  padding: 64px 32px;
  color: var(--text-secondary);
}

.empty-state-icon {
  font-size: 60px; /* אייקון גדול יותר */
  margin-bottom: 20px;
  opacity: 0.4;
}

.data-management {
  background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  padding: 28px; /* הגדלת פאדינג */
  box-shadow: var(--shadow-sm); /* צללית קלה */
}

.data-actions {
  display: grid;
  grid-template-columns: 1fr 1fr auto;
  gap: 12px;
}

.info-box {
  margin-top: 20px; /* מרווח גדול יותר */
  padding: 18px; /* פאדינג גדול יותר */
  background: var(--bg-primary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
  font-size: 14px; /* גודל פונט קריא */
  color: var(--text-secondary);
  line-height: 1.6;
  box-shadow: var(--shadow-sm);
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(16px); } /* אנימציה בולטת יותר */
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideIn {
  from { opacity: 0; transform: translateX(-30px); } /* אנימציה בולטת יותר */
  to { opacity: 1; transform: translateX(0); }
}

.animate-in {
  animation: fadeIn 0.5s ease-out forwards; /* זמן ארוך יותר + forwards לשמירת מצב סופי */
}

.animate-slide {
  animation: slideIn 0.4s ease-out forwards;
}

/* Mobile optimizations */
input, button { font-size: 16px !important; }
button { -webkit-tap-highlight-color: transparent; }
::-webkit-scrollbar { display: none; }

@media (max-width: 640px) {
  .data-actions {
    grid-template-columns: 1fr; /* כפתורים בטור במובייל */
  }
  
  .task-actions {
    flex-wrap: wrap;
    justify-content: flex-end; /* יישור לימין במובייל */
  }
  
  .status-btn {
    width: 44px; /* מעט קטן יותר במובייל כדי לחסוך מקום */
    height: 44px;
    font-size: 16px;
  }
  
  .stat-card {
    padding: 24px 16px;
  }
  
  .stat-value {
    font-size: 36px;
  }
  
  .header h1 {
    font-size: 24px;
  }

  /* שיפורים ספציפיים למובייל כדי למנוע עומס */
  .task-item {
    flex-direction: column; /* כותרת המשימה מעל הכפתורים */
    align-items: flex-start; /* יישור לימין */
    padding: 16px;
  }

  .task-name {
    margin-right: 0;
    margin-bottom: 12px; /* רווח בין שם המשימה לכפתורים */
    font-size: 15px;
  }

  .data-management {
    padding: 20px;
  }
}

  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <h1>מעקב משימות יומיות</h1>
      <p id="currentDate"></p>
    </div>
  </header>

  <main class="container" style="padding-top: 32px;">
    <!-- הודעה מוטיבצית -->
    <section class="section">
      <div id="motivationalMessage" class="message animate-in"></div>
    </section>

    <!-- משימות - עכשיו ראשון -->
    <section class="section">
      <div class="card animate-in">
        <div class="card-header">
          <h2 class="card-title">📋 משימות היום</h2>
        </div>
        <div class="card-body">
          <div style="display: flex; gap: 12px; margin-bottom: 24px;">
            <input type="text" id="newTaskInput" class="input" placeholder="הוסף משימה חדשה" style="flex: 1;">
            <button id="addTaskBtn" class="btn btn-primary">הוסף</button>
          </div>

          <div id="tasksList" style="display: flex; flex-direction: column; gap: 12px;"></div>
          
          <div id="noTasksMessage" class="empty-state" style="display: none;">
            <div class="empty-state-icon">📝</div>
            <p>אין משימות עדיין<br><span style="font-size: 13px; color: var(--text-tertiary);">הוסף משימה ראשונה</span></p>
          </div>
        </div>
      </div>
    </section>

    <!-- סטטיסטיקות - עכשיו שני -->
    <section class="section">
      <div class="grid grid-4">
        <div class="card stat-card animate-in animate-slide">
          <div class="stat-label">היום</div>
          <div id="todayScore" class="stat-value">0%</div>
        </div>
        
        <div class="card stat-card animate-in animate-slide" style="animation-delay: 0.1s;">
          <div class="stat-label">שבועי</div>
          <div id="weeklyAverage" class="stat-value">0%</div>
        </div>
        
        <div class="card stat-card animate-in animate-slide" style="animation-delay: 0.2s;">
          <div class="stat-label">משימות</div>
          <div id="activeTasks" class="stat-value">0</div>
        </div>

        <div class="card stat-card animate-in animate-slide" style="animation-delay: 0.3s;">
          <div class="stat-label">ימי מעקב</div>
          <div id="trackingDays" class="stat-value">0</div>
        </div>
      </div>
    </section>

        <!-- סיכום שבועי - במקום הגרפים -->
    <section class="section">
      <div class="grid grid-2">
        <div class="card animate-in" style="animation-delay: 0.1s;">
          <div class="card-header">
            <h2 class="card-title">📊 סיכום שבועי</h2>
          </div>
          <div class="card-body">
            <div id="weeklyProgress" style="min-height: 280px; display: flex; flex-direction: column; justify-content: center;">
              <!-- יתמלא ב-JavaScript -->
            </div>
          </div>
        </div>

        <div class="card animate-in" style="animation-delay: 0.2s;">
          <div class="card-header">
            <h2 class="card-title">📈 היסטוריית מעקב</h2>
          </div>
          <div class="card-body">
            <div id="trackingHistory" style="min-height: 280px; display: flex; flex-direction: column; justify-content: center;">
              <!-- יתמלא ב-JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ניהול נתונים -->
    <section class="section">
      <div class="data-management animate-in">
        <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600; color: var(--text-primary);">💾 ניהול נתונים</h3>
        
        <div class="data-actions">
          <button id="exportBtn" class="btn btn-secondary">📥 ייצא</button>
          <label class="btn btn-secondary" style="cursor: pointer;">
            📤 יבא
            <input type="file" id="importInput" accept=".json" style="display: none;">
          </label>
          <button id="clearAllBtn" class="btn btn-danger btn-icon">🗑️</button>
        </div>
        
        <div class="info-box">
          <strong>💡 הוסף לבית:</strong> לחץ על כפתור השיתוף ובחר "הוסף למסך הבית".<br>
          <strong>💾 שמירה אוטומטית:</strong> הנתונים נשמרים אוטומטית במכשיר.
        </div>
      </div>
    </section>
  </main>
  
  <script>
    let tasks = [];
    let dailyRecords = {};
    let currentDate = new Date().toISOString().split('T')[0];
    let weeklyChart, trendChart;

    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      setupEventListeners();
      updateCurrentDate();
      updateMotivationalMessage();
      updateTasksList();
      updateStatistics();
      updateVisualReports();
    });

    function updateVisualReports() {
      updateWeeklyProgress();
      updateTrackingHistory();
    }

    function updateWeeklyProgress() {
      const weeklyData = getWeeklyData();
      const container = document.getElementById('weeklyProgress');
      
      const weeklyAverage = Math.round(weeklyData.reduce((sum, day) => sum + day.score, 0) / 7);
      
      let html = `
        <div style="text-align: center; margin-bottom: 24px;">
          <div style="font-size: 48px; font-weight: 800; color: #6366f1; margin-bottom: 8px;">${weeklyAverage}%</div>
          <div style="color: #64748b; font-size: 14px; font-weight: 500;">ממוצע שבועי</div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 8px;">
      `;
      
      weeklyData.forEach(day => {
        const width = Math.max(day.score, 3); // מינימום 3% לחזותיות
        const color = day.score >= 80 ? '#10b981' : day.score >= 60 ? '#f59e0b' : '#ef4444';
        
        html += `
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="min-width: 40px; font-size: 13px; font-weight: 500; color: #64748b;">${day.day}</div>
            <div style="flex: 1; background: #f1f5f9; border-radius: 6px; height: 8px; position: relative;">
              <div style="background: ${color}; height: 100%; width: ${width}%; border-radius: 6px; transition: width 0.3s ease;"></div>
            </div>
            <div style="min-width: 35px; font-size: 13px; font-weight: 600; color: ${color};">${day.score}%</div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    function updateTrackingHistory() {
      const container = document.getElementById('trackingHistory');
      const totalDays = Object.keys(dailyRecords).length;
      const totalTasks = tasks.length;
      
      if (totalDays === 0) {
        container.innerHTML = `
          <div style="text-align: center; color: #94a3b8; padding: 40px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">📅</div>
            <p>התחל לעקוב אחר המשימות<br><small style="opacity: 0.7;">ההיסטוריה תופיע כאן</small></p>
          </div>
        `;
        return;
      }

      // חישוב סטטיסטיקות
      const allScores = Object.keys(dailyRecords).map(date => calculateDayScore(date));
      const bestDay = Math.max(...allScores);
      const averageScore = Math.round(allScores.reduce((sum, score) => sum + score, 0) / allScores.length);
      const streak = calculateCurrentStreak();

      let html = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
          <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: #10b981;">${bestDay}%</div>
            <div style="font-size: 12px; color: #64748b; font-weight: 500;">היום הטוב ביותר</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: #6366f1;">${streak}</div>
            <div style="font-size: 12px; color: #64748b; font-weight: 500;">רצף ימים טובים</div>
          </div>
        </div>
        
        <div style="background: #f8fafc; border-radius: 8px; padding: 16px;">
          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #374151;">סיכום כללי</h4>
          <div style="display: flex; flex-direction: column; gap: 8px; font-size: 13px;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #64748b;">ימי מעקב:</span>
              <span style="font-weight: 600; color: #374151;">${totalDays}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #64748b;">ממוצע כללי:</span>
              <span style="font-weight: 600; color: #374151;">${averageScore}%</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #64748b;">משימות פעילות:</span>
              <span style="font-weight: 600; color: #374151;">${totalTasks}</span>
            </div>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    function calculateCurrentStreak() {
      const sortedDates = Object.keys(dailyRecords).sort().reverse();
      let streak = 0;
      
      for (const date of sortedDates) {
        const score = calculateDayScore(date);
        if (score >= 70) { // יום "טוב" = 70% ומעלה
          streak++;
        } else {
          break;
        }
      }
      
      return streak;
    }

    function loadData() {
      const savedTasks = localStorage.getItem('dailyTracker_tasks');
      const savedRecords = localStorage.getItem('dailyTracker_records');
      
      if (savedTasks) {
        tasks = JSON.parse(savedTasks);
      } else {
        tasks = [
          { id: 1, name: 'התעמלות בוקר', required: true },
          { id: 2, name: 'קריאה', required: true },
          { id: 3, name: 'מדיטציה', required: true }
        ];
      }
      
      if (savedRecords) {
        dailyRecords = JSON.parse(savedRecords);
      }
    }

    function saveData() {
      localStorage.setItem('dailyTracker_tasks', JSON.stringify(tasks));
      localStorage.setItem('dailyTracker_records', JSON.stringify(dailyRecords));
    }

    function setupEventListeners() {
      document.getElementById('addTaskBtn').addEventListener('click', addTask);
      document.getElementById('newTaskInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') addTask();
      });
      document.getElementById('exportBtn').addEventListener('click', exportData);
      document.getElementById('importInput').addEventListener('change', importData);
      document.getElementById('clearAllBtn').addEventListener('click', clearAllData);
    }

    function addTask() {
      const input = document.getElementById('newTaskInput');
      const taskName = input.value.trim();
      
      if (taskName) {
        const newTask = { id: Date.now(), name: taskName, required: true };
        tasks.push(newTask);
        input.value = '';
        saveData();
        updateUI();
      }
    }

    function removeTask(taskId) {
      tasks = tasks.filter(task => task.id !== taskId);
      Object.keys(dailyRecords).forEach(date => {
        if (dailyRecords[date][taskId]) {
          delete dailyRecords[date][taskId];
        }
      });
      saveData();
      updateUI();
    }

    function updateTaskStatus(taskId, status) {
      if (!dailyRecords[currentDate]) {
        dailyRecords[currentDate] = {};
      }
      dailyRecords[currentDate][taskId] = status;
      saveData();
      updateUI();
    }

    function getTaskStatus(taskId, date = currentDate) {
      return dailyRecords[date]?.[taskId] || 'not-done';
    }

    function calculateDayScore(date) {
      const dayTasks = tasks.length;
      if (dayTasks === 0) return 100;
      
      let score = 0;
      tasks.forEach(task => {
        const status = getTaskStatus(task.id, date);
        if (status === 'done') score += 100;
        else if (status === 'partial') score += 50;
      });
      
      return Math.round(score / dayTasks);
    }

    function getLast7Days() {
      const days = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toISOString().split('T')[0]);
      }
      return days;
    }

    function getWeeklyData() {
      return getLast7Days().map(date => {
        const dateObj = new Date(date);
        const dayName = dateObj.toLocaleDateString('he-IL', { weekday: 'short' });
        return { day: dayName, score: calculateDayScore(date), date: date };
      });
    }

    function getMotivationalMessage() {
      const todayScore = calculateDayScore(currentDate);
      
      if (todayScore >= 90) {
        return { type: 'success', message: '🔥 עבודה מצוינת! ההתמדה שלך מרשימה!' };
      } else if (todayScore >= 70) {
        return { type: 'success', message: '👏 התקדמות טובה! אתה בדרך הנכונה!' };
      } else if (todayScore >= 50) {
        return { type: 'warning', message: '⚡ יש מקום לשיפור. נסה להתמקד יותר.' };
      } else if (todayScore >= 25) {
        return { type: 'warning', message: '💪 היום לא היה הכי מוצלח. מחר יכול להיות טוב יותר!' };
      } else {
        return { type: 'danger', message: '🌅 זה היה יום קשה. זכור שמחר תמיד אפשר להתחיל מחדש!' };
      }
    }

    function updateUI() {
      updateCurrentDate();
      updateMotivationalMessage();
      updateTasksList();
      updateStatistics();
      updateVisualReports();
    }

    function updateCurrentDate() {
      const dateElement = document.getElementById('currentDate');
      const date = new Date(currentDate);
      dateElement.textContent = date.toLocaleDateString('he-IL', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
      });
    }

    function updateMotivationalMessage() {
      const message = getMotivationalMessage();
      const element = document.getElementById('motivationalMessage');
      element.textContent = message.message;
      element.className = `message animate-in message-${message.type}`;
    }

    function updateTasksList() {
      const container = document.getElementById('tasksList');
      const noTasksMsg = document.getElementById('noTasksMessage');
      
      if (tasks.length === 0) {
        container.innerHTML = '';
        noTasksMsg.style.display = 'block';
        return;
      }
      
      noTasksMsg.style.display = 'none';
      
      container.innerHTML = tasks.map(task => {
        const status = getTaskStatus(task.id);
        return `
          <div class="task-item">
            <div class="task-name">${task.name}</div>
            <div class="task-actions">
              <button onclick="updateTaskStatus(${task.id}, 'done')" 
                      class="status-btn ${status === 'done' ? 'success' : ''}" 
                      title="הושלם">✅</button>
              <button onclick="updateTaskStatus(${task.id}, 'partial')" 
                      class="status-btn ${status === 'partial' ? 'warning' : ''}" 
                      title="חלקי">⏱️</button>
              <button onclick="updateTaskStatus(${task.id}, 'not-done')" 
                      class="status-btn ${status === 'not-done' ? 'danger' : ''}" 
                      title="לא הושלם">❌</button>
              <button onclick="removeTask(${task.id})" 
                      class="status-btn" 
                      title="מחק">🗑️</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateStatistics() {
      const todayScore = calculateDayScore(currentDate);
      const weeklyData = getWeeklyData();
      const weeklyAverage = Math.round(weeklyData.reduce((sum, day) => sum + day.score, 0) / 7);
      
      document.getElementById('todayScore').textContent = `${todayScore}%`;
      document.getElementById('weeklyAverage').textContent = `${weeklyAverage}%`;
      document.getElementById('activeTasks').textContent = tasks.length;
      document.getElementById('trackingDays').textContent = Object.keys(dailyRecords).length;
    }

    function initCharts() {
      // Check if Chart.js is available
      if (typeof Chart === 'undefined') {
        console.warn('Chart.js not loaded. Showing fallback message.');
        document.getElementById('weeklyChart').style.display = 'none';
        document.getElementById('weeklyChartFallback').style.display = 'block';
        document.getElementById('trendChart').style.display = 'none';
        document.getElementById('trendChartFallback').style.display = 'block';
        return;
      }

      try {
        const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        
        Chart.defaults.font.family = 'Inter';
        Chart.defaults.color = '#475569';

        // Create gradients for weekly chart
        const weeklyGradient = weeklyCtx.createLinearGradient(0, 0, 0, 280);
        weeklyGradient.addColorStop(0, '#6366f1');
        weeklyGradient.addColorStop(1, '#8b5cf6');

        // Create gradients for trend chart  
        const trendGradient = trendCtx.createLinearGradient(0, 0, 0, 280);
        trendGradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
        trendGradient.addColorStop(1, 'rgba(16, 185, 129, 0.02)');

        weeklyChart = new Chart(weeklyCtx, {
          type: 'bar',
          data: { 
            labels: [], 
            datasets: [{ 
              data: [], 
              backgroundColor: weeklyGradient,
              borderRadius: 8,
              borderSkipped: false
            }] 
          },
          options: { 
            responsive: true, 
            maintainAspectRatio: false,
            scales: { 
              y: { 
                beginAtZero: true, 
                max: 100,
                grid: { color: '#e2e8f0' },
                ticks: { callback: function(value) { return value + '%'; } }
              },
              x: { grid: { display: false } }
            }, 
            plugins: { legend: { display: false } },
            elements: { bar: { borderRadius: 8 } }
          }
        });

        trendChart = new Chart(trendCtx, {
          type: 'line',
          data: { 
            labels: [], 
            datasets: [{ 
              data: [], 
              borderColor: '#10b981', 
              backgroundColor: trendGradient,
              borderWidth: 3, 
              pointRadius: 6,
              pointBackgroundColor: '#10b981',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 3,
              fill: true,
              tension: 0.4
            }] 
          },
          options: { 
            responsive: true, 
            maintainAspectRatio: false,
            scales: { 
              y: { 
                beginAtZero: true, 
                max: 100,
                grid: { color: '#e2e8f0' },
                ticks: { callback: function(value) { return value + '%'; } }
              },
              x: { grid: { display: false } }
            }, 
            plugins: { legend: { display: false } }
          }
        });

        console.log('Charts initialized successfully!');
      } catch (error) {
        console.error('Error initializing charts:', error);
        document.getElementById('weeklyChart').style.display = 'none';
        document.getElementById('weeklyChartFallback').style.display = 'block';
        document.getElementById('trendChart').style.display = 'none';
        document.getElementById('trendChartFallback').style.display = 'block';
      }
    }

    function updateCharts() {
      const weeklyData = getWeeklyData();
      
      // Check if charts exist before updating
      if (weeklyChart && weeklyChart.data) {
        weeklyChart.data.labels = weeklyData.map(d => d.day);
        weeklyChart.data.datasets[0].data = weeklyData.map(d => d.score);
        weeklyChart.update();
      }
      
      if (trendChart && trendChart.data) {
        trendChart.data.labels = weeklyData.map(d => d.day);
        trendChart.data.datasets[0].data = weeklyData.map(d => d.score);
        trendChart.update();
      }
    }

    function exportData() {
      const data = { tasks: tasks, records: dailyRecords, exportDate: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tasks-backup-${currentDate}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = JSON.parse(e.target.result);
            if (data.tasks && data.records) {
              tasks = data.tasks;
              dailyRecords = data.records;
              saveData();
              updateUI();
              alert('הנתונים יובאו בהצלחה! ✅');
            } else {
              alert('קובץ לא תקין ❌');
            }
          } catch (error) {
            alert('שגיאה בקריאת הקובץ ⚠️');
          }
        };
        reader.readAsText(file);
      }
    }

    function clearAllData() {
      if (confirm('🗑️ למחוק את כל הנתונים? פעולה זו בלתי הפיכה!')) {
        localStorage.removeItem('dailyTracker_tasks');
        localStorage.removeItem('dailyTracker_records');
        tasks = [];
        dailyRecords = {};
        updateUI();
        alert('הנתונים נמחקו 🧹');
      }
    }
  </script>
</body>
</html>
